<template>
    <div class="home home-bd">
        <div class="header">
            <div class="search">
                <div class="search-inner">
                    <input type="text" placeholder="大额券" />
                </div>
            </div>
            <div class="category">
                <div class="item active">发现</div>
                <div class="item">好券直播</div>
                <div class="item">食品</div>
                <div class="item">美妆</div>
                <div class="item">母婴</div>
            </div>
        </div>
        <div style="height: 3.5rem;"></div>
        <div class="main">
            <div class="banner">
                <input type="file" accept="image/jpeg,image/png,image/gif" onchange="addBanner" />
                <div class="swiper-container" id="banner">
                    <div class="swiper-wrapper">
                        <v-for data="bannerList">
                            <div class="swiper-slide">
                                <img width="100%" :src="item.image" />
                                <div class="delete" onclick="handleDelete(item)">删除</div>
                            </div>
                        </v-for>
                    </div>
                    <div class="swiper-pagination" id="pagination"></div>
                    <!--分页器。如果放置在swiper-container外面，需要自定义样式。-->
                </div>
            </div>

            <div class="fast-track">
                <v-for data="fastTrack">
                    <form class="item">
                        <img :src="item.icon" />
                        <input type="file" accept="image/jpeg,image/png,image/gif" onchange="handleUploadImage" />
                        <input type="hidden" name="icon" :value="item.icon" />
                        <input type="hidden" name="id" :value="item.id" />
                        <div class="title">
                            <input type="text" name="title" :value="item.title" />
                        </div>
                        <button type="button" onclick="handleUpdate">更新</button>
                    </form>
                </v-for>
                <!-- <form class="item">
                    <input type="file" accept="image/jpeg,image/png,image/gif" onchange="handleUploadImage" />
                    <input type="hidden" name="icon" value="" />
                    <input type="hidden" name="type" value="2" />
                    <input type="hidden" name="typeName" value="fastTrack" />
                    <div class="title">
                        <input type="text" name="title" value="" />
                    </div>
                    <button type="button" onclick="handleAdd">新增</button>
                </form> -->
            </div>

            <div class="hot-commodity">
                <div class="head flex">
                    <div class="item">
                        <div>
                            <b class="title f15">今日必推</b>
                            <div class="qs"></div>
                        </div>
                        <div>
                            <span class="g7 f12">每日0点开抢，距离结束</span>
                        </div>
                    </div>
                    <div class="g9 f12 more">更多</div>
                </div>
                <div class="body">
                    <v-for data="hotCommodity">
                        <form class="media">
                            <div class="cover" :style="'background-image:url(' + item.image + ')'">
                                商品图片
                                <input type="file" accept="image/jpeg,image/png,image/gif" onchange="handleUploadImage" />
                                <input type="hidden" name="image" :value="item.image" />
                                <input type="hidden" name="id" :value="item.id" />
                            </div>
                            <div class="info">
                                <div class="ell title"><input type="text" name="title" :value="item.title" /></div>
                                <div class="sub-title f12"><input type="text" name="subTitle" :value="item.subTitle" /></div>
                                <div class="flex">
                                    <span class="g9 f12">剩余<input type="number" name="content" :value="item.content" />件</span>
                                </div>
                                <div style="margin-top: 0.5rem;">
                                    <div class="item">
                                        <span class="g7 f12">抢购价</span>
                                        ￥<input type="number" name="price" :value="item.price" />
                                    </div>
                                    <div>赚￥<input type="number" name="earn" :value="item.earn" /></div>
                                </div>
                                <div class="flex">
                                    <div class="item tc">
                                        <div class="btn" onclick="handleUpdate">更新</div>
                                    </div>
                                    <div class="item tc">
                                        <div class="btn" onclick="handleDelete(item)">删除</div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </v-for>

                    <form class="media">
                        <div class="cover">
                            商品图片
                            <input type="file" accept="image/jpeg,image/png,image/gif" onchange="handleUploadImage" />
                            <input type="hidden" name="image" value="" />
                            <input type="hidden" name="type" value="7" />
                            <input type="hidden" name="typeName" value="hot" />
                        </div>
                        <div class="info">
                            <div class="ell title"><input type="text" name="title" value="" /></div>
                            <div class="sub-title f12"><input type="text" name="subTitle" value="前10名领券优惠--元" /></div>
                            <div class="flex">
                                <span class="g9 f12">剩余<input type="number" name="content" value="10" />件</span>
                            </div>
                            <div style="margin-top: 0.5rem;">
                                <div class="item">
                                    <span class="g7 f12">抢购价</span>
                                    ￥<input type="number" name="price" value="" />
                                </div>
                                <div>赚￥<input type="number" name="earn" value="" /></div>
                            </div>
                            <div class="flex">
                                <div class="btn" onclick="handleAdd">新增</div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <div class="ad">
                <input type="file" accept="image/jpeg,image/png,image/gif" onchange="addAdBanner" />
                <div class="ad-banner">
                    <img width="100%" height="100%" :src="adBanner.image" />
                </div>
                <div class="ad-list">
                    <v-for data="recommendList">
                        <form class="item recommend-form" :style="'background-image:url(' + item.image + ')'">
                            推广图{index}
                            <input type="file" accept="image/jpeg,image/png,image/gif" onchange="handleUploadImage" />
                            <input type="hidden" name="image" :value="item.image" />
                            <input type="hidden" name="title" :value="item.title" />
                            <input type="hidden" name="subTitle" :value="item.subTitle" />
                            <input type="hidden" name="id" :value="item.id" />
                            <div>
                                <button type="button" onclick="handleUpdate">保存</button>
                            </div>
                        </form>
                    </v-for>
                </div>
            </div>

            <v-for data="columnList">
                <div class="recommend-item">
                    <form class="head" :style="'background-image:url(' + item.image + ')'">
                        <div class="title flex">
                            <img class="column-icon" :src="item.icon" alt="" />
                            <input type="file" accept="image/jpeg,image/png,image/gif" onchange="handleUploadImage" />
                            <input type="hidden" name="image" :value="item.image" />
                            <input type="hidden" name="id" :value="item.id" />
                        </div>
                        <div class="flex">
                            <div class="item tc">
                                <div class="btn" onclick="handleUpdate">更新</div>
                            </div>
                            <div class="item tc">
                                <div class="btn" onclick="handleDelete(item)">删除</div>
                            </div>
                        </div>
                    </form>
                    <div class="body">
                        <div class="swiper-container column-goods">
                            <div class="swiper-wrapper">
                                <form class="goods-item swiper-slide">
                                    <div class="cover">
                                        <input type="file" accept="image/jpeg,image/png,image/gif" onchange="handleUploadImage" />
                                        <input type="hidden" name="image" value="" />
                                        <input type="hidden" name="parentId" :value="item.id" />
                                        <input type="hidden" name="type" value="6" />
                                        <input type="hidden" name="typeName" value="goods" />
                                    </div>
                                    <div class="info">
                                        <span class="coupons"><span class="text">券</span>
                                            <input type="number" name="coupon" value="" placeholder="券面值" />
                                        </span>
                                        <div class="price">
                                            <span class="g9">券后</span>
                                            <span><span class="f10">￥</span>
                                                <input type="number" name="couponPrice" value="" placeholder="券后多少" />
                                            </span>
                                        </div>
                                    </div>
                                    <div class="share">
                                        <span class="f12">赚￥</span>
                                        <input type="number" name="earn" value="" placeholder="赚多少" />
                                    </div>
                                    <div class="flex">
                                        <div class="item tc">
                                            <div class="btn" onclick="handleAdd">添加</div>
                                        </div>
                                    </div>
                                </form>
                                <v-for data="item.children">
                                    <form class="goods-item swiper-slide">
                                        <div class="cover" :style="'background-image:url(' + item.image + ')'">
                                            <input type="file" accept="image/jpeg,image/png,image/gif" onchange="handleUploadImage" />
                                            <input type="hidden" name="image" :value="item.image" />
                                            <input type="hidden" name="id" :value="item.id" />
                                        </div>
                                        <div class="info">
                                            <span class="coupons"><span class="text">券</span>
                                                <input type="number" name="coupon" :value="item.coupon" />
                                            </span>
                                            <div class="price">
                                                <span class="g9">券后</span>
                                                <span><span class="f10">￥</span>
                                                    <input type="number" name="couponPrice" :value="item.couponPrice" />
                                                </span>
                                            </div>
                                        </div>
                                        <div class="share">
                                            <span class="f12">赚￥</span>
                                            <input type="number" name="earn" :value="item.earn" />
                                        </div>

                                        <div class="flex">
                                            <div class="item tc">
                                                <div class="btn" onclick="handleUpdate">更新</div>
                                            </div>
                                            <div class="item tc">
                                                <div class="btn" onclick="handleDelete(item)">删除</div>
                                            </div>
                                        </div>
                                    </form>
                                </v-for>
                            </div>
                        </div>
                    </div>
                </div>
            </v-for>

            <form class="recommend-item">
                <div class="head">
                    <div class="title flex">
                        <input type="file" accept="image/jpeg,image/png,image/gif" onchange="handleUploadImage" />
                        <input type="hidden" name="image" value="" />
                        <input type="hidden" name="type" value="5" />
                        <input type="hidden" name="typeName" value="column" />
                    </div>
                </div>
                <div class="body tc">
                    <button type="button" onclick="handleAdd">添加</button>
                </div>
            </form>
        </div>

        <Nav :active="0"></Nav>
    </div>

</template>
<script>
    import MediaItem from '@/components/MediaItem.html';
    import Nav from '@/components/Nav.html';
    import './homeDB.less';
    import $ from '@/assets/jquery-3.4.1.min';

    export default {
        name: 'home',
        component: {
            MediaItem,
            Nav
        },
        data() {
            return {
                title: 1,
                bannerList: [],
                fastTrack: [],
                adBanner: {},
                recommendList: [],
                columnList: [],
                hotCommodity: []
            }
        },
        methods: {
            uploadFile(e, moduleName) {
                const formData = new FormData();
                formData.append('moduleName', moduleName);
                formData.append('file', e.target.files[0]);

                return this.request.post('/api/uploadFile', formData);
            },
            addBanner(e) {
                this.uploadFile(e, 'banner').then(res => {
                    this.request.post('/api/add_commodity', {
                        type: 1,
                        typeName: 'banner',
                        image: res.data
                    }).then(res => {
                        alert('添加成功');
                        location.reload();
                    });
                });
            },
            handleDelete(item) {
                if (confirm('确认删除')) {
                    this.request.get('/api/delete_commodity?id=' + item.id).then(res => {
                        alert('删除成功');
                        location.reload();
                    });
                }
            },
            addAdBanner(e) {
                this.uploadFile(e, 'banner').then(res => {
                    this.request.post('/api/add_commodity', {
                        type: 3,
                        typeName: 'adBanner',
                        image: res.data
                    }).then(res => {
                        alert('更新成功');
                        location.reload();
                    });
                });
            },
            handleUploadImage(e) {
                this.uploadFile(e, 'goods').then(res => {
                    $(e.target).next().val(res.data);
                    alert('图片上传成功');
                });
            },
            handleUpdate(e) {
                const serializeArray = $(e.target).parents('form:first').serializeArray();
                const data = {};
                serializeArray.forEach(item => {
                    data[item.name] = item.value;
                });

                this.request.post('/api/update_commodity', data).then(res => {
                    alert('更新成功');
                    location.reload();
                });
            },
            handleAdd(e) {
                const serializeArray = $(e.target).parents('form:first').serializeArray();
                const data = {};
                serializeArray.forEach(item => {
                    data[item.name] = item.value;
                });

                this.request.post('/api/add_commodity', data).then(res => {
                    alert('添加成功');
                    location.reload();
                });
            },
            initData() {
                Promise.all([
                    this.request.get('/api/get_banner_list'),
                    this.request.get('/api/get_entrance_list'),
                    this.request.get('/api/get_ad_banner'),
                    this.request.get('/api/get_recommend_list'),
                    this.request.get('/api/get_column_list'),
                    this.request.get('/api/get_commodity_list?type=7'), // 今日推荐
                ]).then(resArr => {
                    this.setData({
                        bannerList: resArr[0].data.list,
                        fastTrack: resArr[1].data.list,
                        adBanner: resArr[2].data.entity,
                        recommendList: resArr[3].data.list,
                        columnList: resArr[4].data.list,
                        hotCommodity: resArr[5].data.list,
                    }, () => {
                        new Swiper('#banner', {
                            autoplay: false,//可选选项，自动滑动
                            pagination: '#pagination',
                        });
                        new Swiper('.column-goods', {
                            autoplay: false,//可选选项，自动滑动
                            slidesPerView: 1
                        });
                    });
                });
            },
        },
        mounted() {
            this.initData();
        }
    }

</script>